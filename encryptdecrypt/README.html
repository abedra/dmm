<!DOCTYPE HTML>
<html lang="en-US" >
    
    <head>
        
        <meta charset="UTF-8">
        <title>Encrypt/Decrypt | Deterministic Memory Management on the JVM</title>
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="generator" content="GitBook 1.0.2">
        <meta name="HandheldFriendly" content="true"/>
        <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-status-bar-style" content="black">
        <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../gitbook/images/apple-touch-icon-precomposed-152.png">
        <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">
        
    
    
    
    <link rel="next" href="../analyzing_the_heap/README.html" />
    
    
    <link rel="prev" href="../generating_the_response/README.html" />
    

        
    </head>
    <body>
        
        
<link rel="stylesheet" href="../gitbook/style.css">


        
    <div class="book"  data-level="2.4" data-basepath=".." data-revision="1410729756710">
    

<div class="book-summary">
    <div class="book-search">
        <input type="text" placeholder="Type to search" class="form-control" />
    </div>
    <ul class="summary">
        
    	
    	
    	

        

        
    
        
        <li class="chapter " data-level="0" data-path="index.html">
            
                
                    <a href="../index.html">
                        <i class="fa fa-check"></i>
                        
                         Introduction
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="1" data-path="the_problem/README.html">
            
                
                    <a href="../the_problem/README.html">
                        <i class="fa fa-check"></i>
                        
                            <b>1.</b>
                        
                         The Problem
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="2" data-path="an_example/README.html">
            
                
                    <a href="../an_example/README.html">
                        <i class="fa fa-check"></i>
                        
                            <b>2.</b>
                        
                         An Example
                    </a>
                
            
            
            <ul class="articles">
                
    
        
        <li class="chapter " data-level="2.1" data-path="processing_the_request/README.html">
            
                
                    <a href="../processing_the_request/README.html">
                        <i class="fa fa-check"></i>
                        
                            <b>2.1.</b>
                        
                         Processing the Request
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="2.2" data-path="handling_the_request/README.html">
            
                
                    <a href="../handling_the_request/README.html">
                        <i class="fa fa-check"></i>
                        
                            <b>2.2.</b>
                        
                         Handling the Request
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="2.3" data-path="generating_the_response/README.html">
            
                
                    <a href="../generating_the_response/README.html">
                        <i class="fa fa-check"></i>
                        
                            <b>2.3.</b>
                        
                         Generating the Response
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter active" data-level="2.4" data-path="encryptdecrypt/README.html">
            
                
                    <a href="../encryptdecrypt/README.html">
                        <i class="fa fa-check"></i>
                        
                            <b>2.4.</b>
                        
                         Encrypt/Decrypt
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="2.5" data-path="analyzing_the_heap/README.html">
            
                
                    <a href="../analyzing_the_heap/README.html">
                        <i class="fa fa-check"></i>
                        
                            <b>2.5.</b>
                        
                         Analyzing the Heap
                    </a>
                
            
            
        </li>
    

            </ul>
            
        </li>
    
        
        <li class="chapter " data-level="3" data-path="byte_arrays/README.html">
            
                
                    <a href="../byte_arrays/README.html">
                        <i class="fa fa-check"></i>
                        
                            <b>3.</b>
                        
                         Byte Arrays
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="4" data-path="strings/README.html">
            
                
                    <a href="../strings/README.html">
                        <i class="fa fa-check"></i>
                        
                            <b>4.</b>
                        
                         Strings
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="5" data-path="going_off_heap/README.html">
            
                
                    <a href="../going_off_heap/README.html">
                        <i class="fa fa-check"></i>
                        
                            <b>5.</b>
                        
                         Going Off Heap
                    </a>
                
            
            
        </li>
    


        
        <li class="divider"></li>
        <li>
            <a href="http://www.gitbook.io/" target="blank" class="gitbook-link">Published using GitBook</a>
        </li>
        
    </ul>
</div>

    <div class="book-body">
        <div class="body-inner">
            <div class="book-header">
    <!-- Actions Left -->
    <a href="#" class="btn pull-left toggle-summary" aria-label="Toggle summary"><i class="fa fa-align-justify"></i></a>
    <a href="#" class="btn pull-left toggle-search" aria-label="Toggle search"><i class="fa fa-search"></i></a>
    
    <div id="font-settings-wrapper" class="dropdown pull-left">
        <a href="#" class="btn toggle-dropdown" aria-label="Toggle font settings"><i class="fa fa-font"></i>
        </a>
        <div class="dropdown-menu font-settings">
    <div class="dropdown-caret">
        <span class="caret-outer"></span>
        <span class="caret-inner"></span>
    </div>

    <div class="buttons">
        <button type="button" id="reduce-font-size" class="button size-2">A</button>
        <button type="button" id="enlarge-font-size" class="button size-2">A</button>
    </div>

    <div class="buttons font-family-list">
        <button type="button" data-font="0" class="button">Serif</button>
        <button type="button" data-font="1" class="button">Sans</button>
    </div>

    <div class="buttons color-theme-list">
        <button type="button" id="color-theme-preview-0" class="button size-3" data-theme="0">White</button>
        <button type="button" id="color-theme-preview-1" class="button size-3" data-theme="1">Sepia</button>
        <button type="button" id="color-theme-preview-2" class="button size-3" data-theme="2">Night</button>
    </div>
</div>

    </div>

    <!-- Actions Right -->
    
    <div class="dropdown pull-right">
        <a href="#" class="btn toggle-dropdown" aria-label="Toggle share dropdown"><i class="fa fa-share-alt"></i>
        </a>
        <div class="dropdown-menu font-settings dropdown-left">
            <div class="dropdown-caret">
                <span class="caret-outer"></span>
                <span class="caret-inner"></span>
            </div>
            <div class="buttons">
                <button type="button" data-sharing="twitter" class="button">Twitter</button>
                <button type="button" data-sharing="google-plus" class="button">Google</button>
                <button type="button" data-sharing="facebook" class="button">Facebook</button>
                <button type="button" data-sharing="weibo" class="button">Weibo</button>
                <button type="button" data-sharing="instapaper" class="button">Instapaper</button>
            </div>
        </div>
    </div>
    

    
    <a href="#" target="_blank" class="btn pull-right google-plus-sharing-link sharing-link" data-sharing="google-plus" aria-label="Share on Google Plus"><i class="fa fa-google-plus"></i></a>
    
    
    <a href="#" target="_blank" class="btn pull-right facebook-sharing-link sharing-link" data-sharing="facebook" aria-label="Share on Facebook"><i class="fa fa-facebook"></i></a>
    
    
    <a href="#" target="_blank" class="btn pull-right twitter-sharing-link sharing-link" data-sharing="twitter" aria-label="Share on Twitter"><i class="fa fa-twitter"></i></a>
    
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href="../" >Deterministic Memory Management on the JVM</a>
    </h1>
</div>

            <div class="page-wrapper" tabindex="-1">
                <div class="page-inner">
                
                
                    <section class="normal" id="section-gitbook_1">
                    
                        <h1 id="encryptdecrypt">Encrypt/Decrypt</h1>
<p>For our encrypt and decrypt examples we will be using <code>AES-128-CBC</code>, or 128 bit AES encryption
using the <a href="http://en.wikipedia.org/wiki/Block_cipher_mode_of_operation#Cipher-block_chaining_.28CBC.29" target="_blank">Cipher Block Chaining</a>
mode of operation. This mode requires us to provide an initialization vector unique to each
message that will be distributed along with the message. The encryption key is stored in a Java
<a href="http://docs.oracle.com/javase/8/docs/api/java/security/KeyStore.html" target="_blank">KeyStore</a>. The key will be
loaded during the encrypt/decrypt process. The key will not be loaded with the intent of keeping
it in memory for the duration of program execution. Let&#39;s take a look at our <code>Crypto</code> class:</p>
<pre><code class="lang-java"><span class="hljs-keyword">import</span> javax.crypto.*;
<span class="hljs-keyword">import</span> javax.crypto.spec.IvParameterSpec;
<span class="hljs-keyword">import</span> javax.crypto.spec.SecretKeySpec;
<span class="hljs-keyword">import</span> java.io.FileInputStream;
<span class="hljs-keyword">import</span> java.io.IOException;
<span class="hljs-keyword">import</span> java.io.InputStream;
<span class="hljs-keyword">import</span> java.security.*;
<span class="hljs-keyword">import</span> java.security.cert.CertificateException;
<span class="hljs-keyword">import</span> java.util.Properties;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Crypto</span> </span>{
    <span class="hljs-keyword">private</span> <span class="hljs-title">Crypto</span>() { }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> IVLENGTH = <span class="hljs-number">16</span>;

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">byte</span>[] <span class="hljs-title">encrypt</span>(<span class="hljs-keyword">final</span> <span class="hljs-keyword">byte</span>[] message) <span class="hljs-keyword">throws</span> CryptoException {
        <span class="hljs-keyword">byte</span>[] k = loadKey().getEncoded();
        SecretKey secretKey = <span class="hljs-keyword">new</span> SecretKeySpec(k, <span class="hljs-string">"AES"</span>);
        <span class="hljs-keyword">try</span> {
            Cipher cipher = Cipher.getInstance(<span class="hljs-string">"AES/CBC/PKCS5Padding"</span>);
            <span class="hljs-keyword">byte</span>[] iv = generateIv();
            cipher.init(Cipher.ENCRYPT_MODE, secretKey, <span class="hljs-keyword">new</span> IvParameterSpec(iv));
            <span class="hljs-keyword">byte</span>[] encryptedBytes = cipher.doFinal(message);
            <span class="hljs-keyword">return</span> pack(iv, encryptedBytes);
        } <span class="hljs-keyword">catch</span> (NoSuchAlgorithmException | NoSuchPaddingException |
                 InvalidAlgorithmParameterException | InvalidKeyException |
                 BadPaddingException | IllegalBlockSizeException e) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> CryptoException(e.getMessage());
        }
    }
</code></pre>
<p>First, we encounter our <code>encrypt()</code> method. This method takes a <code>byte[]</code> containing the message we
wish to encrypt. It loads the encryption key, generates the initialization vector, and encrypts
the message. Finally, it packs the initialization vector and the encrypted message together and
returns it to the caller. Let&#39;s take a look at the supporting methods.</p>
<pre><code class="lang-java">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Key <span class="hljs-title">loadKey</span>() {
        <span class="hljs-keyword">try</span> {
            Properties properties = <span class="hljs-keyword">new</span> Properties();
            InputStream in = Crypto.class.getResourceAsStream(<span class="hljs-string">"server.properties"</span>);
            properties.load(in);
            in.close();
            String location = properties.getProperty(<span class="hljs-string">"keystore.location"</span>);
            String alias = properties.getProperty(<span class="hljs-string">"keystore.alias"</span>);
            String password = properties.getProperty(<span class="hljs-string">"keystore.password"</span>);
            InputStream inputStream = <span class="hljs-keyword">new</span> FileInputStream(location);
            KeyStore keyStore = KeyStore.getInstance(<span class="hljs-string">"JCEKS"</span>);
            keyStore.load(inputStream, password.toCharArray());
            inputStream.close();

            <span class="hljs-keyword">if</span> (!keyStore.containsAlias(alias)) {
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> RuntimeException(<span class="hljs-string">"Key alias not found"</span>);
            }

            <span class="hljs-keyword">return</span> keyStore.getKey(alias, password.toCharArray());
        } <span class="hljs-keyword">catch</span> (KeyStoreException | CertificateException |
                 NoSuchAlgorithmException | IOException |
                 UnrecoverableKeyException e) {
            e.printStackTrace();
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> RuntimeException(<span class="hljs-string">"Could not load key"</span>);
        }
    }
</code></pre>
<p>We have seen the <code>loadKey()</code> method previously. We used it to dump our encryption key so we could
search for it on the heap.</p>
<pre><code class="lang-java">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">byte</span>[] <span class="hljs-title">generateIv</span>() {
        <span class="hljs-keyword">byte</span>[] iv = <span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[IVLENGTH];
        SecureRandom random = <span class="hljs-keyword">new</span> SecureRandom();
        random.nextBytes(iv);
        <span class="hljs-keyword">return</span> iv;
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">byte</span>[] <span class="hljs-title">pack</span>(<span class="hljs-keyword">final</span> <span class="hljs-keyword">byte</span>[] iv, <span class="hljs-keyword">final</span> <span class="hljs-keyword">byte</span>[] encryptedBytes) {
        <span class="hljs-keyword">byte</span>[] finalBytes = <span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[iv.length + encryptedBytes.length];
        System.arraycopy(iv, <span class="hljs-number">0</span>, finalBytes, <span class="hljs-number">0</span>, iv.length);
        System.arraycopy(encryptedBytes, <span class="hljs-number">0</span>, finalBytes, iv.length, encryptedBytes.length);
        <span class="hljs-keyword">return</span> finalBytes;
    }
</code></pre>
<p>Next we have our <code>generateIv()</code> and <code>pack()</code> methods. They are pretty self explanatory. The only
thing to note here is that we are using Java&#39;s <code>SecureRandom</code> class to produce the data for our
initialization vector. Now we can look at our <code>decrypt()</code> method.</p>
<pre><code class="lang-java">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">byte</span>[] <span class="hljs-title">decrypt</span>(<span class="hljs-keyword">final</span> <span class="hljs-keyword">byte</span>[] encryptedBytes) <span class="hljs-keyword">throws</span> CryptoException {
        <span class="hljs-keyword">byte</span>[] k = loadKey().getEncoded();
        SecretKey secretKey = <span class="hljs-keyword">new</span> SecretKeySpec(k, <span class="hljs-string">"AES"</span>);
        <span class="hljs-keyword">try</span> {
            Cipher cipher = Cipher.getInstance(<span class="hljs-string">"AES/CBC/PKCS5Padding"</span>);
            cipher.init(Cipher.DECRYPT_MODE, secretKey, <span class="hljs-keyword">new</span> IvParameterSpec(getIv(encryptedBytes)));
            <span class="hljs-keyword">return</span> cipher.doFinal(getMessage(encryptedBytes));
        } <span class="hljs-keyword">catch</span> (NoSuchPaddingException | InvalidAlgorithmParameterException |
                 NoSuchAlgorithmException | IllegalBlockSizeException |
                 BadPaddingException | InvalidKeyException e) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> CryptoException(e.getMessage());
        }
    }
</code></pre>
<p>As we expect <code>decrypt()</code> is a lot like <code>encrypt()</code>. It loads the key, extracts the initialization
vector and the message, and performs the decrypt operation. the following support methods are used
to unpack the message into the proper parts.</p>
<pre><code class="lang-java">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">byte</span>[] <span class="hljs-title">getIv</span>(<span class="hljs-keyword">final</span> <span class="hljs-keyword">byte</span>[] encryptedBytes) {
        <span class="hljs-keyword">byte</span>[] iv = <span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[IVLENGTH];
        System.arraycopy(encryptedBytes, <span class="hljs-number">0</span>, iv, <span class="hljs-number">0</span>, IVLENGTH);
        <span class="hljs-keyword">return</span> iv;
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">byte</span>[] <span class="hljs-title">getMessage</span>(<span class="hljs-keyword">final</span> <span class="hljs-keyword">byte</span>[] encryptedBytes) {
        <span class="hljs-keyword">int</span> length = (encryptedBytes.length - IVLENGTH);
        <span class="hljs-keyword">byte</span>[] messageBytes = <span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[length];
        System.arraycopy(encryptedBytes, IVLENGTH, messageBytes, <span class="hljs-number">0</span>, length);
        <span class="hljs-keyword">return</span> messageBytes;
    }
}
</code></pre>
<p>There are a few things we are missing in this code. The most noteworthy is that the encryption is
not being verified. Normally there would be an additional step where we use <code>HMAC</code> to sign the
encrypted payload. This ensures that the message was not tampered with. It was intentionally left
out of the example because it provides no further demonstration of the problem. Normally you would
also see a <code>Base64</code> encode/decode operation along with the encryption. That is being done in our
<code>RequestHandler</code> object. There are many other ciphers and block modes of operation. Some are
arguably better at this task. This example code aims to provide a sample that is still considered
sound and valid for use while demonstrating the problem.</p>

                    
                    </section>
                
                
                </div>
            </div>
        </div>

        
        <a href="../generating_the_response/README.html" class="navigation navigation-prev " aria-label="Previous page: Generating the Response"><i class="fa fa-angle-left"></i></a>
        
        
        <a href="../analyzing_the_heap/README.html" class="navigation navigation-next " aria-label="Next page: Analyzing the Heap"><i class="fa fa-angle-right"></i></a>
        
    </div>
</div>

        
<script src="../gitbook/app.js"></script>

    
    <script src="https://cdn.mathjax.org/mathjax/2.0-latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    

    
    <script src="../gitbook/plugins/gitbook-plugin-mathjax/plugin.js"></script>
    

<script>
require(["gitbook"], function(gitbook) {
    var config = {"fontSettings":{"theme":null,"family":"sans","size":2}};
    gitbook.start(config);
});
</script>

        
    </body>
    
</html>
